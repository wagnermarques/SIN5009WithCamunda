#+Title: Camunda Anots
#+Subtitle:

* Introducao e Apresentacao deste material   
* Download e Instalacao
** Setup Environment 
 
  #+NAME:  setup environment                   
  #+BEGIN_SRC shell :session s1 :results output :exports both
     #starts code
     export thisRepoDir=/home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/SIN5009WithCamunda
     export ECLIPSE_HOME=$thisRepoDir/tools/eclipse-jee-2019-09-R-linux-gtk-x86_64
     export ESB_HOME=$thisRepoDir/tools/talend/Runtime_ESBSE/container
     export ESB_DEPLOY_DIR=$ESB_HOME/deploy
     export ESB_CMD="$ESB_HOME/bin/client -r 7"
     export CAMUNDA_BPM_PLATFORM_HOME=$thisRepoDir/tools/camunda_bpm
     export CAMUNDA_BPM_PLATFORM_DEPLOY_DIR=$CAMUNDA_BPM_PLATFORM_HOME/server/apache-tomcat-9.0.19/webapps
     export M2_REPO=/home/wagner/wagnerdocri@gmail.com3/fzlbpms/fzlStudio/integrated/build/apache-maven-3.6.0/
     
     export CAMUNDA_BPM_MODELER_HOME=$thisRepoDir/tools/camunda-modeler-3.3.5-linux-x64
  #+END_SRC

  #+RESULTS: setup environment
  : 
  : CAMUNDA_BPM_PLATFORM_HOME/start-camunda.sh

* Rodando o Camunda BPM Platform, Camunda Modeler e ESB (Talend)
** Rodando o camunda platform
 
   O comando abaixo roda a plataforma camunda 
   Sera aberta no navegador a seguinte url
   http://localhost:8080/camunda/app/admin/default/#/login

   
   #+NAME:                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
     
   #+END_SRC

  #+NAME: $CAMUNDA_BPM_PLATFORM_HOME/start-camunda.sh
  #+BEGIN_SRC shell :session s1 :results output :exports both
     #Comando para startart o camunda
     $CAMUNDA_BPM_PLATFORM_HOME/start-camunda.sh &

     #use esse comando abaixo pra parar o camunda
     #$CAMUNDA_BPM_PLATFORM_HOME/shutdown-camunda.sh

     #xterm -hold  -e "tail -f $CAMUNDA_BPM_PLATFORM_HOME/server/apache-tomcat-9.0.19/logs/catalina.out" &
  #+END_SRC

  #+RESULTS: $CAMUNDA_BPM_PLATFORM_HOME/start-camunda.sh
  : 
  : [5] 10431

** Rodando o camunda modeler
   #+NAME: $CAMUNDA_BPM_MODELER_HOME/camunda-modeler                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code      
      $CAMUNDA_BPM_MODELER_HOME/camunda-modeler &
   #+END_SRC

   #+RESULTS: $CAMUNDA_BPM_MODELER_HOME/camunda-modeler
   : 
   : CAMUNDA_BPM_PLATFORM_HOME/start-camunda.sh
   : [3] 6318

** Rodando nosso ESB (Talend )

   #+NAME: rodando esb
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      cd $ESB_HOME && ./bin/start
      xterm -hold -e "tail -f $ESB_HOME/log/tesb.log" &
   #+END_SRC

   #+RESULTS: rodando esb
   : 
   : CAMUNDA_BPM_PLATFORM_HOME/start-camunda.sh
   : [wagner@Unknown container]$ [3] 2865

** Rodando o eclipse IDE
   
   #+NAME: rodando o eclipse IDE
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      $ECLIPSE_HOME/eclipse &
   #+END_SRC

   #+RESULTS: rodando o eclipse IDE
   : 
   : [4] 6418

* Acesssando o Camunda BPM Platform, Camunda Modeler e ESB (Karaf)
** Acessando nossas ferramentas instaladas
   A ideia aqui e so acessar pra ver se esta tudo funcionando
*** Acessando o camunda BPM

    http://localhost:8080/camunda/app/admin/default/#/login

    pra ver os logs do camunda, usar o comando abaixo...

    Usuario: Administrador

    Senha: Administrador

*** Acessando o camunda BPM (Api rest)
    Da pra consultar a referencia da api rest aqui:https://docs.camunda.org/manual/7.5/reference/rest/

**** Deployments 

   #+NAME:qtos deployments                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      echo "Qtos deployments?"
      echo $(curl --fail --silent --show-error localhost:8080/engine-rest/deployment/count)
      echo "----------------------------------------------------------------------"
      echo "."  
   #+END_SRC

   #+RESULTS: qtos deployments
   : 
   : Qtos deployments?
   : {"count":5}
   : ----------------------------------------------------------------------
   : .
   
   #+NAME:fazer deploy
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      echo "Fazer deploy"
      echo $(curl --fail --silent --show-error localhost:8080/engine-rest/deployment/create)
      echo "----------------------------------------------------------------------"
      echo "."

   #+END_SRC

**** process definitions
     https://docs.camunda.org/manual/7.5/reference/rest/process-definition/
     
***** Quantos processos estao definidos?
   #+NAME:/process-definition/count
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      echo "Engine name"
      echo $(curl --fail --silent --show-error localhost:8080/engine-rest/process-definition/count)
      echo "----------------------------------------------------------------------"
      echo "."

   #+END_SRC

   #+RESULTS: /process-definition/count
   : 
   : Engine name
   : {"count":5}
   : ----------------------------------------------------------------------
   : .


***** Quais sao eles?
   
   #+NAME: quais sao os projetos definidos                   
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      echo "Engine name"
      echo $(curl --fail --silent --show-error -o process-definition.json localhost:8080/engine-rest/process-definition && cat process-definition.json)
      echo "----------------------------------------------------------------------"
      echo "."
   #+END_SRC

   #+RESULTS: quais sao os projetos definidos
   : 
   : Engine name
   : [{"id":"invoice:1:5df34a11-fdd4-11e9-b303-7440bbfe2c2f","key":"invoice","category":"http://www.omg.org/spec/BPMN/20100524/MODEL","description":null,"name":"Invoice Receipt","version":1,"resource":"invoice.v1.bpmn","deploymentId":"5de1e4ed-fdd4-11e9-b303-7440bbfe2c2f","diagram":null,"suspended":false,"tenantId":null,"versionTag":"V1.0","historyTimeToLive":30,"startableInTasklist":true},{"id":"invoice:2:5e2d1ecb-fdd4-11e9-b303-7440bbfe2c2f","key":"invoice","category":"http://www.omg.org/spec/BPMN/20100524/MODEL","description":null,"name":"Invoice Receipt","version":2,"resource":"invoice.v2.bpmn","deploymentId":"5e268f17-fdd4-11e9-b303-7440bbfe2c2f","diagram":null,"suspended":false,"tenantId":null,"versionTag":"V2.0","historyTimeToLive":45,"startableInTasklist":true}]
   : ----------------------------------------------------------------------
   : .

***** undeploy     

     #+NAME:deployments list e delete                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      echo "List deployments"
      #echo $(curl -X DELETE --fail --silent --show-error localhost:8080/engine-rest/deploymentId
      echo $(curl -X "DELETE" --silent --show-error localhost:8080/engine-rest/deployment/ab2b0a11-012a-11ea-8864-7440bbfe2c2f?cascade=true)
      echo "----------------------------------------------------------------------"
      echo "."  
   #+END_SRC

   #+RESULTS: deployments list e delete
   : 
   : List deployments
   : [wagner@localhost SIN5009WithCamunda]$
   : ----------------------------------------------------------------------
   : .


**** iniciando um processo
     https://docs.camunda.org/manual/7.7/reference/rest/process-definition/post-start-process-instance/
     
   #+NAME: iniciando processo                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
     #starts code     
      echo "Iniciando processo"
      echo $(curl --fail --silent --show-error localhost:8080/engine-rest/execution/count)
      #echo .
      #echo $(curl --fail --silent --show-error -X POST localhost:8080/engine-rest/process-definition/idProcessCliente:2:092b3210-0192-11ea-b2fe-7440bbfe2c2f/start --data '{"businessKey"="5","canal_de_comunicacao"="email"})
      #echo .
      #echo $(curl --fail --silent --show-error localhost:8080/engine-rest/execution/count)
      #echo "----------------------------------------------------------------------"
      #echo "."
   #+END_SRC

   #+RESULTS: iniciando processo
   : 
   : Iniciando processo
   : {"count":8}
   : .
   : curl: (22) The requested URL returned error: 415
   : .
   : {"count":8}
   : ----------------------------------------------------------------------
   : .


**** Quantos estao executando?
   https://docs.camunda.org/manual/7.5/reference/rest/execution/
   
   #+NAME: /executionx
   #+BEGIN_SRC shell :session s1 :results output :exports both
   #starts code
   echo "Get Executions"
   echo $(curl --fail --silent --show-error localhost:8080/engine-rest/execution)
   echo "----------------------------------------------------------------------\n"
   #+END_SRC

   #+RESULTS: /executionx
   : 
   : Get Executions
   : [{"id":"5e748850-fdd4-11e9-b303-7440bbfe2c2f","processInstanceId":"5e748850-fdd4-11e9-b303-7440bbfe2c2f","ended":false,"tenantId":null},
   :  {"id":"5fc46010-fdd4-11e9-b303-7440bbfe2c2f","processInstanceId":"5fc46010-fdd4-11e9-b303-7440bbfe2c2f","ended":false,"tenantId":null},
   :  {"id":"5feca8d7-fdd4-11e9-b303-7440bbfe2c2f","processInstanceId":"5feca8d7-fdd4-11e9-b303-7440bbfe2c2f","ended":false,"tenantId":null},
   :  {"id":"5ffa3d9d-fdd4-11e9-b303-7440bbfe2c2f","processInstanceId":"5feca8d7-fdd4-11e9-b303-7440bbfe2c2f","ended":false,"tenantId":null},
   :  {"id":"6005132c-fdd4-11e9-b303-7440bbfe2c2f","processInstanceId":"6005132c-fdd4-11e9-b303-7440bbfe2c2f","ended":false,"tenantId":null},
   :  {"id":"600c665c-fdd4-11e9-b303-7440bbfe2c2f","processInstanceId":"600c665c-fdd4-11e9-b303-7440bbfe2c2f","ended":false,"tenantId":null},
   :  {"id":"601e8e12-fdd4-11e9-b303-7440bbfe2c2f","processInstanceId":"601e8e12-fdd4-11e9-b303-7440bbfe2c2f","ended":false,"tenantId":null},
   :  {"id":"6028a068-fdd4-11e9-b303-7440bbfe2c2f","processInstanceId":"601e8e12-fdd4-11e9-b303-7440bbfe2c2f","ended":false,"tenantId":null}]
   : ----------------------------------------------------------------------\n


   
*** Acessando o camunda Modeler
*** Acesando o nosso esb 
    É possivel acessar o esb talend pelo menos de duas maneiras:

**** webconsole
     Usando o webconsole do karaf

     http://localhost:8181/system/console/bundles
    
     Usando webconsole no talend
     
     https://localhost:9001/system/console/bundles

*** linha de comando do karaf
    
   #+NAME:                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      #cd $ESB_HOME && ./bin/stop
      #$ESB_CMD "feature:list | grep console"
      #$ESB_CMD "feature:list | grep camel"
      #$ESB_CMD "camel:context-list"
      #$ESB_CMD "camel:endpoint-list"

   #+END_SRC

* Criando o processo
  
   #+NAME: mvn clean package antrun:copy.war.into.tomcat
   #+BEGIN_SRC shell :session s1 :results output :exports both
     cd $thisRepoDir/processapps/AgDeViagens
     mvn clean package antrun:copy.war.into.tomcat
   #+END_SRC

   #+RESULTS: mvn clean package antrun:copy.war.into.tomcat
   #+begin_example

   [[1;34mINFO[m] Scanning for projects...
   [[1;34mINFO[m] [1m------------------------------------------------------------------------[m
   [[1;34mINFO[m] [1;31mBUILD FAILURE[m
   [[1;34mINFO[m] [1m------------------------------------------------------------------------[m
   [[1;34mINFO[m] Total time:  1.753 s
   [[1;34mINFO[m] Finished at: 2019-11-06T21:12:51-02:00
   [[1;34mINFO[m] [1m------------------------------------------------------------------------[m
   [1m[Help 1][m
   [[1;31mERROR[m] 
   [[1;31mERROR[m] To see the full stack trace of the errors, re-run Maven with the [1m-e[m switch.
   [[1;31mERROR[m] Re-run Maven using the [1m-X[m switch to enable full debug logging.
   [[1;31mERROR[m] 
   [[1;31mERROR[m] For more information about the errors and possible solutions, please read the following articles:
   [[1;31mERROR[m] [1m[Help 1][m http://cwiki.apache.org/confluence/display/MAVEN/MojoNotFoundException
   #+end_example

* Instalando (Deploy) os artefatos de software para rodar o processo

** Instalando no esb dependencias necessarias pra rodar nossos servicos

      #+NAME:  installnig component                   
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      #no talend nao precisa
      #https://camel.apache.org/components/latest/jasypt.html
      cd $ESB_CMD feature:install camel-jasypt
   #+END_SRC


** Instalando servicos no barramento de servicos
   Agora que a gente ligou nossos servidores falta instalar ainda o que
   vamos rodar neles. Por exemplo, falta instalar os processos e os
   servicos no barramento de servicos.

*** Instalando os webservices no nosso barramento de servicos
    
    Caso tenha algum servico no barramento, vamos remover todos pra
    comecar do zero.

    Remover os servicos do barramento significa apenas apagar os
    artefatos na pasta deploy
   #+NAME:  undeploy all                   
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      rm $ESB_HOME/deploy/*
   #+END_SRC

   #+RESULTS: undeploy all
   : 
   : rm: nÃ£o foi possÃ­vel remover '/home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/SIN5009NonBpmnEngineArtifacts/talend/Runtime_ESBSE/container/deploy/*': No such file or directory


    Fazendo deploy dos servicos

   #+NAME: instalando servicos no barramento                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      #ls -l $diretorioDeProjetos
      #cp -f $diretorioDeProjetos/UspTimerExample_CamelBlueprintCxt.xml $ESB_HOME/deploy
      cp -f $diretorioDeProjetos/UspAgenciaViagens_CamelBLueprintCtx.xml $ESB_HOME/deploy
      #cp -f $diretorioDeProjetos/cxf-blueprint-camel-example/target/cxf-blueprint-camel-example-1.0-SNAPSHOT.jar $ESB_HOME/deploy
      

      #cxf-blueprint-camel-example-1.0-SNAPSHOT.jar
      #osgi:install -s mvn:com.capgemini.example/cxf-blueprint-camel-example/1.0-SNAPSHOT
      
   #+END_SRC

   #+RESULTS: instalando servicos no barramento


   Aqui nos simulamos a criacao o agente de viagens que recebeu o
   cliente na agencia, preencheu um arquivo e salvou na pasta
   especifica que sempre qdo um arquivo chega nessa pasta o processo
   sera iniciado.
   
   #+NAME:  simula salvar arquivo de solicitacao na pastaDeSolicitacaoDeClientes                   
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      
      echo "arquivo de solicitacao 1" > $PastaDeSolicitacaoDeClientes/ArqDeSol1.txt
      ls -l $PastaDeSolicitacaoDeClientes
   #+END_SRC

   #+RESULTS: simula salvar arquivo de solicitacao na pastaDeSolicitacaoDeClientes
   : 
   : [wagner@nsi_pc_149_3 pastaDeSolicitacaoDeClientes]$ [wagner@nsi_pc_149_3 pastaDeSolicitacaoDeClientes]$ total 4
   : -rw-rw-r--. 1 wagner wagner 25 out 24 09:37 ArqDeSol1.txt

*** Conferindos se esta tudo pronto pra rodar o processo
**** Conferindo karaf (nosso esb)
     
     verificando se nossos bundles estao instalados e ativos

     #+NAME:Conferindos se esta tudo pronto pra rodar
     #+BEGIN_SRC shell :session s1 :results output :exports both
        #starts code
        #$ESB_CMD "bundle:list"
        #$ESB_CMD "camel:list-context"
        $ESB_CMD "camel:context-stop CamelContextName--RecebeSolicitacaoDoCliente"
     #+END_SRC

     #+RESULTS: Conferindos se esta tudo pronto pra rodar
     : 
     : CAMUNDA_BPM_MODELER_HOME/camunda-modeler
     : [wagner@Unknown apache-karaf-4.2.6]$ Logging in as karaf
     : [31mCommand not found: [0m[31;1mcamel:list-context[0m



*** rest operations
**** rest with curl
     
   #+NAME:  curl
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      curl -v -H "Accept:application/json" http://localhost:8080/engine-rest/case-instance/count       
      #curl --request GET -L -v  http://localhost:8080/engine-rest/case-instance/count
   #+END_SRC

   #+RESULTS: curl


**** deploy
   https://docs.camunda.org/manual/7.7/reference/rest/deployment/post-deployment/  
   #+NAME:  deploy                   
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      
   #+END_SRC

*** urls references
    
**** Página de boas vindas que mostra as appps do camunda
     localhost:8080/camunda-welcome/index.html

**** app cockpit
     localhost:8080/camunda/app/cockpit/


**** Admin    
     Pra entender melhor o app admin acesse:
     https://docs.camunda.org/manual/7.11/webapps/admin/
     
     http://localhost:8080/camunda/app/admin/default/#/

**** Login:      
     http://localhost:8080/camunda/app/welcome/default/#!/login

    


*** Getting started
    
   #+NAME:                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      cd $projdir
      mvn package

   #+END_SRC

   
   #+NAME:                     
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      
   #+END_SRC

** Usando Camunda Modeler e rodando um processo e integrando ele com nossa logica de negocio
   
* Criando um processo
  
  
  
   #+NAME: start eclipse
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      $ECLIPSE_HOME/eclipse &
   #+END_SRC

   #+RESULTS: start eclipse
   : 
   : [2] 14284


   depois de abrir o eclipse copie a url do repositorio remoto do
   camunda conforme abaixo. Depois a gente vai colar no eclipse, pro
   eclipse poder encontrar os archetypes (modelos de projetos) do
   camunda.

   [[../imgs/camunda1.png]]


   Agora, no eclipe vá em Window -> Preferences -> Maven -> Archetypes
   Clique no botao add remote catalog 
   
   e cole o repositorio, conforme a img abaixo

   [[../imgs/camunda2.png]]

   tem isso mais detalhado em
   https://docs.camunda.org/manual/7.11/user-guide/process-applications/maven-archetypes/

Meu eclipse acabou nao encontrando nenhum archetype nesse repositorio
remoto, mas dando um mvn archetype:generate vc vai encontrar eesses
archetypes listados lá...

camunda4.png
* referencias
  https://docs.camunda.org/get-started/quick-start/


* Desligando todos os tools
  
   #+NAME: Desligando todos os tools    
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      #use esse comando abaixo pra parar o camunda
      $CAMUNDA_BPM_PLATFORM_HOME/shutdown-camunda.sh

      #O Camunda modeler he so fechar pela interface grafica dele

      #Desligando ESB Talend
      cd $ESB_HOME && ./bin/stop
   #+END_SRC

   #+RESULTS: Desligando todos os tools
   #+begin_example

   CAMUNDA_BPM_PLATFORM_HOME/server/apache-tomcat-9.0.19/logs/catalina.out"  (wd: ~/wagnerdocri@gmail.com3/envs/env-dev/sources/SIN5009WithCamunda)
   (wd agora: ~/wagnerdocri@gmail.com3/envs/env-dev/sources/SIN5009WithCamunda/tools/talend/Runtime_ESBSE/container)
   Using CATALINA_BASE:   /home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/SIN5009WithCamunda/tools/camunda_bpm/server/apache-tomcat-9.0.19
   Using CATALINA_HOME:   /home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/SIN5009WithCamunda/tools/camunda_bpm/server/apache-tomcat-9.0.19
   Using CATALINA_TMPDIR: /home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/SIN5009WithCamunda/tools/camunda_bpm/server/apache-tomcat-9.0.19/temp
   Using JRE_HOME:        /home/wagner/PROGSATIVOS/jdk1.8.0_191
   Using CLASSPATH:       /home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/SIN5009WithCamunda/tools/camunda_bpm/server/apache-tomcat-9.0.19/bin/bootstrap.jar:/home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/SIN5009WithCamunda/tools/camunda_bpm/server/apache-tomcat-9.0.19/bin/tomcat-juli.jar
   nov 03, 2019 1:46:58 AM org.apache.catalina.startup.Catalina stopServer
   GRAVE: Could not contact [localhost:8005] (base port [8005] and offset [0]). Tomcat may not be running.
   nov 03, 2019 1:46:58 AM org.apache.catalina.startup.Catalina stopServer
   GRAVE: Error stopping Catalina
   java.net.ConnectException: Connection refused (Connection refused)
           at java.net.PlainSocketImpl.socketConnect(Native Method)
           at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)
           at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)
           at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)
           at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
           at java.net.Socket.connect(Socket.java:589)
           at java.net.Socket.connect(Socket.java:538)
   (Socket.java:434)
   (Socket.java:211)
           at org.apache.catalina.startup.Catalina.stopServer(Catalina.java:513)
           at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
           at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
           at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
           at java.lang.reflect.Method.invoke(Method.java:498)
           at org.apache.catalina.startup.Bootstrap.stopServer(Bootstrap.java:403)
           at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:497)
   #+end_example
